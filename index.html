<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Cifrado Móvil</title>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* Estilos generales y Modo Oscuro */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #1e1e1e;
            color: #f0f0f0;
            transition: background-color 0.5s, color 0.5s;
            margin: 0; /* Elimina márgenes por defecto del body */
            width: 100vw; /* Asegura el ancho total de la pantalla */
        }
        h1 {
            color: #4CAF50;
            text-align: center;
            font-size: 1.5em; /* Tamaño de fuente amigable para móviles */
        }
        #controls {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column; /* Apila elementos verticalmente en móvil */
            gap: 10px;
            width: 90%; /* Ancho de los controles */
            max-width: 400px;
        }
        input[type="text"] {
            padding: 12px;
            font-size: 1em;
            text-align: center;
            border: 1px solid #444;
            background-color: #333;
            color: #f0f0f0;
            border-radius: 8px; /* Bordes más suaves */
        }
        button {
            padding: 12px 18px;
            font-size: 1em;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #45a049;
        }
        #resultadoCifrado {
            font-weight: bold;
            margin: 15px 0;
            color: #88ccff;
            text-align: center;
            padding: 0 10px;
            font-size: 0.9em;
        }

        /* Contenedor del QR: ocupa el 75% del ancho de la pantalla */
        #qr-canvas-container {
            width: 75vw; /* 75% del ancho del viewport */
            height: 75vw; /* Mantiene la proporción cuadrada */
            max-width: 400px; /* Límite para pantallas grandes */
            max-height: 400px;
            
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #555;
            background-color: #000;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5); 

            /* Asegura que el canvas se estire para llenar el contenedor */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Estilo para el canvas dentro del contenedor */
        #qrCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>
<body>

    <h1>Generador QR Cifrado Animado</h1>

    <div id="controls">
        <input type="text" id="numeroOriginal" maxlength="8" placeholder="Ingresa 8 dígitos (Ej: 25221231)" required>
        <button onclick="generarCifradoYQR()">Generar QR Animado</button>
    </div>

    <p id="resultadoCifrado"></p>

    <div id="qr-canvas-container">
        <canvas id="qrCanvas"></canvas>
    </div>

    <script>
        // Clave de desplazamiento y configuración de animación
        const CLAVE = [9, 1, 8, 0, 1, 0, 2, 1];
        const ANIMATION_DELAY = 5; // Retraso reducido para una animación más rápida en móvil

        let animationTimeoutId; 

        /** Cifra el número usando el desplazamiento aditivo módulo 10. */
        function cifrarNumero(numero) {
            let numeroCifrado = "";
            for (let i = 0; i < 8; i++) {
                const digitoOriginal = parseInt(numero[i]);
                const claveDigito = CLAVE[i];
                const digitoCifrado = (digitoOriginal + claveDigito) % 10;
                numeroCifrado += digitoCifrado.toString();
            }
            return numeroCifrado;
        }

        /**
         * Anima la construcción del código QR módulo por módulo en el canvas.
         * Se determina el tamaño de la celda dinámicamente para llenar el 100% del contenedor.
         */
        function animateQrConstruction(pattern, ctx, canvas) {
            clearTimeout(animationTimeoutId); 

            const qrSize = pattern.length;
            
            // Usamos el tamaño físico del canvas para dibujar (necesario para el dibujo)
            // y lo ajustamos para que ocupe todo el contenedor.
            const containerSize = canvas.parentElement.offsetWidth;
            canvas.width = containerSize;
            canvas.height = containerSize;

            const CELL_SIZE = containerSize / qrSize; // Tamaño de celda dinámico

            ctx.fillStyle = '#ffffff'; 
            ctx.fillRect(0, 0, containerSize, containerSize); // Pinta el fondo del QR de blanco

            let currentModuleIndex = 0;
            const totalModules = qrSize * qrSize;

            function drawNextModule() {
                if (currentModuleIndex >= totalModules) return;

                const y = Math.floor(currentModuleIndex / qrSize);
                const x = currentModuleIndex % qrSize;

                const color = pattern[y][x] ? '#000000' : '#ffffff'; 
                
                ctx.fillStyle = color;
                ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);

                currentModuleIndex++;
                animationTimeoutId = setTimeout(drawNextModule, ANIMATION_DELAY);
            }

            drawNextModule(); 
        }

        /** Función principal: valida, cifra, y anima el QR. */
        function generarCifradoYQR() {
            const inputElement = document.getElementById("numeroOriginal");
            const numStr = inputElement.value.trim();
            const resultadoCifradoElement = document.getElementById("resultadoCifrado");
            const qrCanvas = document.getElementById("qrCanvas");
            const ctx = qrCanvas.getContext("2d");

            if (numStr.length !== 8 || !/^\d{8}$/.test(numStr)) {
                alert("Por favor, ingresa un número exacto de 8 dígitos.");
                resultadoCifradoElement.textContent = "";
                ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height); 
                clearTimeout(animationTimeoutId);
                return;
            }

            const numeroCifrado = cifrarNumero(numStr);
            resultadoCifradoElement.textContent = `Original: ${numStr} → Cifrado: ${numeroCifrado}`;

            // 1. Generar el patrón del QR (matriz de booleanos)
            // Se usa un div dummy para obtener el patrón de la librería sin renderizar
            const qr = new QRCode(document.createElement('div'), {
                text: numeroCifrado,
                width: 1, 
                height: 1,
                correctLevel: QRCode.CorrectLevel.L
            });
            const pattern = qr._oQRCode.modules;

            // 2. Animar y dibujar el patrón en el canvas
            animateQrConstruction(pattern, ctx, qrCanvas);
        }

        // Inicializar el canvas al cargar y reajustar al cambiar tamaño de ventana
        function setupCanvas() {
            const qrCanvas = document.getElementById("qrCanvas");
            const containerSize = qrCanvas.parentElement.offsetWidth;
            qrCanvas.width = containerSize;
            qrCanvas.height = containerSize;
            const ctx = qrCanvas.getContext("2d");
            ctx.fillStyle = '#1e1e1e';
            ctx.fillRect(0, 0, containerSize, containerSize);
        }

        window.onload = setupCanvas;
        window.onresize = setupCanvas; // Vuelve a ajustar si el usuario rota el móvil o cambia el tamaño
    </script>

</body>
</html>
