<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Cifrado | Efecto "Verde a Negro"</title>
    
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* Estilos generales y Modo Oscuro (se mantiene para la interfaz, pero el QR será blanco) */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #1e1e1e; /* Fondo oscuro de la app */
            color: #f0f0f0;
            margin: 0;
            width: 100vw;
        }
        h1 {
            color: #4CAF50;
            text-align: center;
            font-size: 1.5em;
        }
        #controls {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 90%;
            max-width: 400px;
        }
        input[type="text"] {
            padding: 12px;
            font-size: 1em;
            text-align: center;
            border: 1px solid #444;
            background-color: #333;
            color: #f0f0f0;
            border-radius: 8px;
        }
        button {
            padding: 12px 18px;
            font-size: 1em;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #45a049;
        }
        #resultadoCifrado {
            font-weight: bold;
            margin: 15px 0;
            color: #88ccff;
            text-align: center;
            padding: 0 10px;
            font-size: 0.9em;
        }

        /* Contenedor del QR: ocupará el 75% del ancho de la pantalla */
        #qr-canvas-container {
            width: 75vw; 
            height: 75vw; 
            max-width: 400px;
            max-height: 400px;
            
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #555;
            background-color: #ffffff; /* Fondo BLANCO para la zona del QR */
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5); /* Sombra luminosa verde */

            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Estilo para el canvas dentro del contenedor */
        #qrCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
    </style>
</head>
<body>

    <h1>Generador QR Cifrado Animado</h1>

    <div id="controls">
        <input type="text" id="numeroOriginal" maxlength="8" placeholder="Ingresa 8 dígitos (Ej: 25221231)" required>
        <button onclick="generarCifradoYQR()">Generar QR Animado</button>
    </div>

    <p id="resultadoCifrado"></p>

    <div id="qr-canvas-container">
        <canvas id="qrCanvas"></canvas>
    </div>

    <script>
        // Clave de cifrado y configuración de animación
        const CLAVE = [9, 1, 8, 0, 1, 0, 2, 1];
        const ANIMATION_DELAY = 1;      // Retraso entre cada módulo
        const COLOR_FLASH_DELAY = 50;  // Tiempo de espera para el cambio de color (verde a negro)

        let animationTimeoutId; 

        /** Cifra el número usando el desplazamiento aditivo módulo 10. */
        function cifrarNumero(numero) {
            let numeroCifrado = "";
            for (let i = 0; i < 8; i++) {
                const digitoOriginal = parseInt(numero[i]);
                const claveDigito = CLAVE[i];
                const digitoCifrado = (digitoOriginal + claveDigito) % 10;
                numeroCifrado += digitoCifrado.toString();
            }
            return numeroCifrado;
        }

        /**
         * Dibuja un módulo con un efecto de transición de color.
         * @param {CanvasRenderingContext2D} ctx El contexto 2D.
         * @param {number} x Coordenada X del módulo.
         * @param {number} y Coordenada Y del módulo.
         * @param {number} cellSize Tamaño de la celda.
         */
        function drawAnimatedModule(ctx, x, y, cellSize) {
            const X_POS = x * cellSize;
            const Y_POS = y * cellSize;
            
            // 1. Dibuja el píxel con color verde brillante (efecto "flash")
            ctx.fillStyle = '#00FF00'; 
            ctx.fillRect(X_POS, Y_POS, cellSize, cellSize);

            // 2. Programa el cambio a negro después de un breve retraso
            setTimeout(() => {
                ctx.fillStyle = '#000000'; // Color final: Negro
                ctx.fillRect(X_POS, Y_POS, cellSize, cellSize);
            }, COLOR_FLASH_DELAY);
        }

        /** Anima la construcción del código QR módulo por módulo en el canvas. */
        function animateQrConstruction(pattern, ctx, canvas) {
            clearTimeout(animationTimeoutId); 

            const qrSize = pattern.length;
            
            const containerSize = canvas.parentElement.offsetWidth;
            canvas.width = containerSize;
            canvas.height = containerSize;

            const CELL_SIZE = containerSize / qrSize; 

            // **Paso clave:** El canvas se pinta completamente de blanco
            ctx.fillStyle = '#ffffff'; 
            ctx.fillRect(0, 0, containerSize, containerSize); 

            let currentModuleIndex = 0;
            const totalModules = qrSize * qrSize;

            function drawNextModule() {
                if (currentModuleIndex >= totalModules) return;

                const y = Math.floor(currentModuleIndex / qrSize);
                const x = currentModuleIndex % qrSize;

                // Solo actuamos sobre los píxeles NEGROS (true en el patrón)
                if (pattern[y][x]) {
                    drawAnimatedModule(ctx, x, y, CELL_SIZE);
                } 
                // Los píxeles blancos (false en el patrón) se omiten, ya que el fondo ya es blanco.

                currentModuleIndex++;
                animationTimeoutId = setTimeout(drawNextModule, ANIMATION_DELAY);
            }

            drawNextModule(); 
        }

        /** Función principal: valida, cifra, y anima el QR. */
        function generarCifradoYQR() {
            const inputElement = document.getElementById("numeroOriginal");
            const numStr = inputElement.value.trim();
            const resultadoCifradoElement = document.getElementById("resultadoCifrado");
            const qrCanvas = document.getElementById("qrCanvas");
            const ctx = qrCanvas.getContext("2d");

            if (numStr.length !== 8 || !/^\d{8}$/.test(numStr)) {
                alert("Por favor, ingresa un número exacto de 8 dígitos.");
                resultadoCifradoElement.textContent = "";
                // Limpia y pinta el canvas de blanco si hay error
                ctx.fillStyle = '#ffffff'; 
                ctx.fillRect(0, 0, qrCanvas.width, qrCanvas.height); 
                clearTimeout(animationTimeoutId);
                return;
            }

            const numeroCifrado = cifrarNumero(numStr);
            resultadoCifradoElement.textContent = `Original: ${numStr} → Cifrado: ${numeroCifrado}`;

            // 1. Generar el patrón del QR (matriz de booleanos)
            const qr = new QRCode(document.createElement('div'), {
                text: numeroCifrado,
                width: 1, 
                height: 1,
                correctLevel: QRCode.CorrectLevel.L
            });
            const pattern = qr._oQRCode.modules;

            // 2. Animar y dibujar el patrón en el canvas
            animateQrConstruction(pattern, ctx, qrCanvas);
        }

        // Inicializar el canvas y reajustar al cambiar tamaño de ventana
        function setupCanvas() {
            const qrCanvas = document.getElementById("qrCanvas");
            const containerSize = qrCanvas.parentElement.offsetWidth;
            qrCanvas.width = containerSize;
            qrCanvas.height = containerSize;
            const ctx = qrCanvas.getContext("2d");
            
            // Pinta el canvas de blanco para el estado inicial
            ctx.fillStyle = '#ffffff'; 
            ctx.fillRect(0, 0, containerSize, containerSize);
        }

        window.onload = setupCanvas;
        window.onresize = setupCanvas; 
    </script>

</body>
</html>
